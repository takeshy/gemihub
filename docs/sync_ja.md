# 同期

ブラウザ（IndexedDB）と Google Drive 間の手動 Push/Pull 同期。

## 機能

- **手動同期**: 任意のタイミングで Push / Pull を実行
- **オフラインファースト**: ファイルは IndexedDB にキャッシュされ即座にアクセス可能
- **コンフリクト解決**: ローカルまたはリモート版を選択し、選ばれなかった方は自動バックアップ
- **自動チェック**: 5分ごとに変更を検出
- **Full Push / Full Pull**: 初期セットアップやリカバリ用の一括同期
- **未追跡ファイル管理**: リモートの孤立ファイルを検出・復元・削除

## コマンド

| コマンド | 説明 |
|---------|------|
| **Push** | ローカルの変更をアップロード（差分） |
| **Pull** | リモートの変更をダウンロード（差分） |
| **Full Push** | ローカルの全ファイルをアップロード + メタデータをリモートにマージ |
| **Full Pull** | リモートの全ファイルをダウンロード（ハッシュ一致分はスキップ） |

ヘッダーボタン: Push と Pull ボタンは常に表示されます。バッジにはローカル編集ファイル数を含む保留中の変更数が表示されます。

---

## 同期の仕組み

### 概要

メタデータでファイルの状態を追跡します:
- **ローカルメタ**: IndexedDB に保存（`syncMeta` ストア、キー `"current"`）
- **リモートメタ**: Google Drive 上の `_sync-meta.json` ファイル

各メタデータの内容:
- `lastUpdatedAt`: 最終同期のタイムスタンプ
- `files`: ファイルごとの MD5 チェックサムと更新日時（ファイル ID がキー）

ファイル内容は IndexedDB の `files` ストアにキャッシュされます。全ての編集はこのキャッシュを直接更新します。MD5 チェックサムは Google Drive API がファイル操作（作成・更新・読取）のたびに返します。

### 三者間 Diff

Diff アルゴリズムは3つのデータソースを比較します:

| ソース | 説明 |
|--------|------|
| **ローカルメタ** | クライアント側の最終同期スナップショット（IndexedDB） |
| **リモートメタ** | サーバー側の最終同期スナップショット（`_sync-meta.json`） |
| **現在のリモート** | Drive API のリアルタイムファイル一覧（diff のたびに再構築） |

ファイルごとの検出ロジック:

| ローカル変更 | リモート変更 | 結果 |
|:----------:|:----------:|------|
| なし | なし | スキップ（変更なし） |
| あり | なし | **toPush** |
| なし | あり | **toPull** |
| あり | あり | **コンフリクト** |
| ローカルのみ | - | **localOnly** |
| - | リモートのみ | **remoteOnly** |

判定条件:
- `localChanged = local.md5Checksum !== remoteSynced.md5Checksum`
- `remoteChanged = currentRemote.md5Checksum !== remoteSynced.md5Checksum`

---

## Push Changes（差分）

ローカルで変更されたファイルをリモートにアップロードします。

### フロー

```
1. 事前チェック: 書き込み前に Diff を確認
   ├─ IndexedDB から LocalSyncMeta を読み取り
   ├─ POST /api/sync { action: "diff" }
   │   └─ サーバー: Drive の _sync-meta.json と比較 → diff を返す
   ├─ コンフリクトあり → 中断（コンフリクトダイアログを表示）
   └─ リモートが新しい & 未 Pull の変更あり → エラー「先に Pull して」

2. アップロード: Drive 上のファイルを直接更新
   ├─ IndexedDB の editHistory から変更ファイル ID を取得
   ├─ 各変更ファイルについて:
   │   ├─ IndexedDB キャッシュから内容を読み取り
   │   ├─ POST /api/drive/files { action: "update", fileId, content }
   │   │   └─ サーバー: Drive 上のファイルを更新、_sync-meta.json を更新
   │   │       → 新しい md5Checksum, modifiedTime を返す
   │   ├─ LocalSyncMeta を新しい md5/modifiedTime で更新
   │   └─ IndexedDB キャッシュを新しい md5/modifiedTime で更新
   └─ lastUpdatedAt = now

3. クリーンアップ
   ├─ IndexedDB の editHistory をクリア（変更は Drive に反映済み）
   ├─ localModifiedCount = 0
   └─ "sync-complete" イベント発火（UI 更新用）

4. メタデータ同期
   ├─ diff を再計算（アップロード後の状態で）
   ├─ toPush が残っていれば → POST /api/sync { action: "push" }
   │   └─ サーバー: _sync-meta.json を更新
   └─ diff を再取得してステータスを更新
```

### 前提条件

| ローカルメタ | リモートメタ | リモートが新しい | アクション |
|:----------:|:----------:|:----------:|--------|
| - | - | - | Push するものなし |
| - | あり | - | Push するものなし |
| あり | あり | はい（未 Pull あり） | エラー: 「先に Pull してください」 |
| あり | あり | いいえ | Push を実行 |

### 重要事項

- Push はコンフリクトおよびリモート優先のチェックを **Drive への書き込み前に** 行います。チェックに失敗した場合、何も書き込まれません。
- Push はリモートファイルを**削除しません**。
- ローカルで削除されたファイルはリモート上で「未追跡」になります（設定から復元可能）。
- Push 成功後、IndexedDB のローカル編集履歴はクリアされます。

---

## Pull Changes（差分）

リモートで変更されたファイルのみローカルキャッシュにダウンロードします。

### フロー

1. **三者間比較で Diff を計算**
2. **コンフリクト確認** — あれば停止してコンフリクト UI を表示
3. **`toPull` + `remoteOnly` 配列を結合**
4. **ファイル内容を並列ダウンロード**（最大5並列）
5. **IndexedDB キャッシュを更新**
6. **ローカル同期メタを更新**（新しいチェックサムで）
7. **Diff を再取得**してステータスを更新

### 判定テーブル

#### 両方のメタに存在するファイル

| ローカルメタ | リモートメタ | アクション |
|:----------:|:----------:|--------|
| A | A | スキップ（変更なし） |
| B | A | スキップ（ローカルのみの変更、次の Push でアップロード） |
| A | B | **ダウンロード**（リモートが変更された） |
| B | C | **コンフリクト**（両方が変更された） |

#### ローカルメタのみに存在するファイル（リモート削除）

| ローカルメタ | リモートメタ | 現在のリモート | アクション |
|:----------:|:----------:|:----------:|--------|
| A | - | - | **localOnly**（ローカルに保持、後で Push 可能） |

#### リモートのみに存在するファイル（新規リモート）

| ローカルメタ | リモートメタ | 現在のリモート | アクション |
|:----------:|:----------:|:----------:|--------|
| - | - | あり | **remoteOnly** → ダウンロード |

---

## Full Pull

リモートの全ファイルをダウンロードします。ハッシュが一致するファイルはスキップされます。

### フロー

1. **`skipHashes` を構築** — IndexedDB キャッシュの全ファイルから（`fileId → md5Checksum`）
2. **リモートメタを再構築** — Drive API でフルスキャン
3. **システムファイルを除外**（`_sync-meta.json`、`settings.json`）
4. **スキップ** — `skipHashes[fileId] === remoteMeta.md5Checksum` のファイル
5. **スキップされなかったファイルを並列ダウンロード**（最大5並列）
6. **ローカル同期メタをリモートメタで完全に置き換え**
7. **IndexedDB キャッシュを更新**

### 使用するタイミング

- 新しいデバイス/ブラウザでの初期セットアップ
- キャッシュ破損からのリカバリ
- リモートを正とみなしたい場合

---

## Full Push

ローカルの変更ファイルを全て Drive に直接アップロードし、メタデータをマージします。

### フロー

1. **変更ファイルをアップロード** — 各変更ファイルを `/api/drive/files` 経由で Drive に直接更新
2. **IndexedDB を更新** — キャッシュと LocalSyncMeta を新しい md5/modifiedTime で更新
3. **ローカルメタの全エントリをリモートの `_sync-meta.json` にマージ**
4. **編集履歴をクリア**

### 使用するタイミング

- リモートのメタデータをローカルの状態に強制的に合わせたい場合
- 通常の同期を経由しない一括ローカル編集の後

---

## コンフリクト解決

コンフリクトは Push または Pull 時に、最後の同期以降にローカルとリモートの両方でファイルが変更された場合に発生します。

| 選択 | 動作 |
|------|------|
| **ローカルを保持** | リモート版を `sync_conflicts/` にバックアップし、リモートメタをローカルのチェックサムで更新 |
| **リモートを保持** | ローカル版を `sync_conflicts/` にバックアップし、リモートの内容を IndexedDB にダウンロード |

選ばれなかった方は必ずバックアップされるため、手動マージが可能です。

### バックアップの命名規則

```
{ファイル名}_{YYYYMMDDTHHmmss}.{拡張子}
```

例: `notes/daily.md` → `sync_conflicts/notes_daily_20260207_143000.md`

---

## 一時同期（Temporary Sync）

フル同期のオーバーヘッドなしにファイルを素早く共有します。以下の場合に使用:
- 単一ファイルをデバイス間で素早く共有したい場合
- リスクのある編集前にバックアップが必要な場合

ファイルは Google Drive 上に `__TEMP__/` プレフィックス付きで保存されます。**メタデータは更新されません** — 両方のデバイスで同じ編集を手動で行うのと同等です。

一時ファイルは設定 → 同期 → 一時ファイルから管理できます。

---

## ファイルリカバリ

### シナリオ 1: コンフリクト — 両方のバージョンが必要

コンフリクト発生時にローカルを保持またはリモートを保持を選びますが、選ばれなかった方は必ず `sync_conflicts/` に保存されます。

**手動マージの手順:**
1. 保持したファイルを開く
2. ファイルツリーで `sync_conflicts/` を開いて、もう一方のバージョンを見つける
3. バックアップから必要な部分をコピーする
4. 完了したらバックアップファイルを削除する

### シナリオ 2: 削除したファイルの復元

ローカルでファイルを削除すると、リモート上で「未追跡」になります。

**復元手順:**
1. 設定 → 同期タブ → 未追跡ファイルの検出
2. 必要なファイルを選択
3. 「選択を復元」をクリック

### シナリオ 3: リモートからの復元

ローカルでファイルを誤って変更・削除してしまい、リモートから復元したい場合。

**復元方法:** **Full Pull** を使用 — リモートの全ファイルをダウンロードし、ハッシュが一致するもののみスキップします。ローカルキャッシュは完全に置き換えられます。

---

## 設定

設定 → 同期タブにセクション別で配置:

### 同期ステータス
- 最終同期日時

### データ管理
| アクション | 説明 |
|-----------|------|
| 一時ファイルを管理 | Drive 上の一時ファイルを閲覧・管理 |
| 未追跡ファイルを検出 | ローカルキャッシュで追跡されていないリモートファイルを検出 |

### 編集履歴
| アクション | 説明 |
|-----------|------|
| 整理 | 古い編集履歴エントリを削除してストレージを解放 |
| 統計 | 編集履歴のストレージ使用量とエントリ数を表示 |

### 危険な操作
| アクション | 説明 |
|-----------|------|
| コンフリクトファイルを削除 | `sync_conflicts/` 内の全バックアップファイルを削除 |
| 完全 Push | ローカルの全ファイルをアップロードしメタデータをマージ（リモートを上書き） |
| 完全 Pull | リモートの全ファイルをダウンロード（ローカルキャッシュを上書き） |

### システムファイル（常に除外）

- `_sync-meta.json` — 同期メタデータ
- `settings.json` — ユーザー設定

---

## 編集履歴

逆適用 diff によるローカル編集追跡。Push 時に Drive に永続化。

### 概要

編集履歴は2つのレイヤーに分かれています:

| レイヤー | ストレージ | 保持期間 |
|---------|-----------|---------|
| **ローカル** | IndexedDB `editHistory` ストア | 次の Push まで（その後クリア） |
| **リモート** | Drive のファイルごとの `.history.json` | 編集履歴設定に従い保持 |

### ローカル編集履歴（IndexedDB）

各ファイルに1つの `CachedEditHistoryEntry`（`diffs[]` 配列付き）があります。各配列要素は1つの diff セッション（コミットポイント）を表します。

**自動保存（5秒ごと）:**
1. IndexedDB キャッシュから旧コンテンツを読み取り（キャッシュ更新前）
2. 最後の diff が存在する場合: 逆適用してベースを復元
3. ベースから新コンテンツへの累積 diff を計算
4. `diffs[]` の最後のエントリを上書き（同セッションの更新は1つの diff に累積）

**コミット境界（明示的な保存イベント）:**
- `diffs[]` に空エントリを境界マーカーとして追加
- 次の自動保存は新しい diff セッションを開始（上書きではなく追加）
- トリガー: ファイル開く/リロード、Pull、一時ダウンロード受入、ワークフローコマンド

**メモリ効率:**
- キャッシュ（最新コンテンツ）+ diff のみ保存（ベースコンテンツの完全コピーなし）
- ベースコンテンツは必要時に逆適用で復元
- 逆適用: `+`/`-` 行とハンクヘッダーのカウントを入れ替え、パッチを適用

### リモート編集履歴（Drive）

Push でファイルを Drive に更新する際、サーバーは:
1. 更新前に Drive から旧ファイル内容を読み取り
2. diff（旧 → 新）を計算
3. ファイルの `.history.json` に diff エントリを追記

Push 後、diff は Drive に保存済みのため IndexedDB の編集履歴はクリアされます。

### 履歴の閲覧

編集履歴モーダルには以下が表示されます:
- **ローカルエントリ**（IndexedDB）がデフォルト — 現在の編集セッションの diff
- **リモートエントリ**（Drive）はオンデマンド — 「リモート履歴を表示」クリックで過去の diff を Drive から読み込み

---

## アーキテクチャ

### データフロー

```
ブラウザ (IndexedDB)          サーバー               Google Drive
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│ files store   │      │ /api/sync    │      │ Root folder  │
│ syncMeta      │◄────►│ (diff/push/  │◄────►│ _sync-meta   │
│ fileTree      │      │  pull/resolve)│      │ User files   │
│ editHistory   │      │              │      │ sync_conflicts│
│               │      │ /api/drive/  │      │ .history.json│
│               │      │  files       │      │ __TEMP__/    │
└──────────────┘      └──────────────┘      └──────────────┘
```

### 主要ファイル

| ファイル | 役割 |
|---------|------|
| `app/hooks/useSync.ts` | クライアント側の同期フック（push, pull, conflict, fullPush, fullPull, localModifiedCount） |
| `app/hooks/useFileWithCache.ts` | IndexedDB キャッシュ優先のファイル読取、編集履歴付き自動保存 |
| `app/routes/api.sync.tsx` | サーバー側の同期 API（10アクション） |
| `app/routes/api.drive.files.tsx` | Drive ファイル CRUD（Push 時のファイル直接更新に使用） |
| `app/services/sync-meta.server.ts` | 同期メタデータの読取・書込・再構築・Diff |
| `app/services/indexeddb-cache.ts` | IndexedDB キャッシュ（files, syncMeta, fileTree, editHistory） |
| `app/services/edit-history-local.ts` | クライアント側の編集履歴（IndexedDB での逆適用 diff） |
| `app/services/edit-history.server.ts` | サーバー側の編集履歴（Drive `.history.json` の読取・書込） |
| `app/services/google-drive.server.ts` | Google Drive API ラッパー |
| `app/utils/parallel.ts` | 並列処理ユーティリティ（同時実行数制限） |

### API アクション

| アクション | メソッド | 説明 |
|-----------|---------|------|
| `diff` | POST | 三者間 Diff 比較 |
| `push` | POST | ローカルのチェックサムでリモートメタを更新 |
| `pull` | POST | 指定 ID のファイル内容をダウンロード |
| `resolve` | POST | コンフリクト解決（敗者をバックアップ、メタを更新） |
| `fullPull` | POST | リモートの全ファイルをダウンロード（一致分はスキップ） |
| `fullPush` | POST | ローカルの全メタをリモートメタにマージ |
| `clearConflicts` | POST | コンフリクトフォルダの全ファイルを削除 |
| `detectUntracked` | POST | 同期メタに含まれない Drive 上のファイルを検出 |
| `deleteUntracked` | POST | 指定の未追跡ファイルを削除 |
| `restoreUntracked` | POST | 指定のファイルを同期メタに復元 |
